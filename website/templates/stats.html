{% extends "base.html" %}
{% block title %}Statistics{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/stats.css') }}" />
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="stats-header">
        <h2>Your Statistics</h2>
        <p>Track your reading progress and achievements</p>
    </div>
    
    <!-- Top Summary Cards -->
    <div class="stats-cards">
        <div class="stat-card">
            <h5>To Read</h5>
            <h2>{{ books_to_read }}</h2>
        </div>
        
        <div class="stat-card">
            <h5>Currently Reading</h5>
            <h2>{{ books_reading }}</h2>
        </div>
        
        <div class="stat-card highlight">
            <h5>Books Read</h5>
            <h2>{{ books_read }}</h2>
        </div>
        
        <div class="stat-card highlight">
            <h5>Pages Read</h5>
            <h2>{{ total_pages_read }}</h2>
        </div>
    </div>
    
    <!-- Charts Section -->
    <div class="charts-section">
        <!-- Reading List Breakdown -->
        <div class="chart-container">
            <h3 class="chart-title">Reading List Breakdown</h3>
            <canvas id="readingListChart"></canvas>
        </div>
        
        <!-- Rating Distribution -->
        <div class="chart-container">
            <h3 class="chart-title">Your Rating Distribution</h3>
            <canvas id="ratingsChart"></canvas>
            <div class="text-center mt-3">
                <h4 class="chart-subtitle">Average Rating: {{ "%.1f"|format(avg_rating) }} / 5</h4>
            </div>
        </div>
        
        <!-- Top Genres -->
        <div class="chart-container">
            <h3 class="chart-title">Top Genres You've Read</h3>
            <canvas id="genresChart"></canvas>
        </div>

        <!-- Monthly Progress -->
        <div class="chart-container">
            <h3 class="chart-title">Monthly Reading Progress</h3>
            <canvas id="monthlyChart"></canvas>
            <div class="text-center mt-3">
                <p class="chart-subtitle"><strong>{{ books_read }} books</strong> and <strong>{{ total_pages_read }} pages</strong> in the last 12 months</p>
            </div>
        </div>
    </div>
    
    <!-- Platform Stats -->
    <div class="platform-stats">
        <h3>Platform Statistics</h3>
        <div class="platform-cards">
            <div class="platform-card">
                <h1>{{ total_books }}</h1>
                <p>Total Books</p>
            </div>
            
            <div class="platform-card">
                <h1>{{ total_reviews }}</h1>
                <p>Total Reviews</p>
            </div>
            
            <div class="platform-card">
                <h1>{{ total_users }}</h1>
                <p>Total Users</p>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="quick-actions">
        <h5>Quick Actions</h5>
        <a href="/books" class="btn btn-secondary">Browse Books</a>
        <a href="/my-reading-list" class="btn btn-success">My Reading List</a>
        <a href="/books/create" class="btn btn-secondary">Add New Book</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<!-- Pass data to JavaScript -->
<script>
window.statsData = {
    readingList: [{{ books_to_read }}, {{ books_reading }}, {{ books_read }}],
    ratings: [
        {{ rating_counts[1] }},
        {{ rating_counts[2] }},
        {{ rating_counts[3] }},
        {{ rating_counts[4] }},
        {{ rating_counts[5] }}
    ],
    genreLabels: [
        {% for genre, count in top_genres %}
        '{{ genre }}'{% if not loop.last %},{% endif %}
        {% endfor %}
    ],
    genres: [
        {% for genre, count in top_genres %}
        {{ count }}{% if not loop.last %},{% endif %}
        {% endfor %}
    ],
    monthLabels: [
        {% for month in months_data %}
        '{{ month.month }}'{% if not loop.last %},{% endif %}
        {% endfor %}
    ],
    monthlyBooks: [
        {% for month in months_data %}
        {{ month.books }}{% if not loop.last %},{% endif %}
        {% endfor %}
    ],
    monthlyPages: [
        {% for month in months_data %}
        {{ month.pages }}{% if not loop.last %},{% endif %}
        {% endfor %}
    ]
};
</script>

<!-- Our custom stats charts -->
<script src="{{ url_for('static', filename='js/stats.js') }}"></script>
{% endblock %}